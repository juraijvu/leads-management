{% extends "base.html" %}

{% block title %}Pipeline - Training Center CRM{% endblock %}

{% block breadcrumb %}
{{ super() }}
<li class="breadcrumb-item active">Sales Pipeline</li>
{% endblock %}

{% block content %}
<!-- Pipeline Statistics -->
<div class="row mb-4">
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="dashboard-card">
            <div class="stat-card">
                <div class="stat-number" id="total-leads">
                    {{ pipeline_data.values() | sum(attribute='count') }}
                </div>
                <div class="stat-label">Total Leads</div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="dashboard-card">
            <div class="stat-card">
                <div class="stat-number text-success" id="conversion-rate">
                    {% set total = pipeline_data.values() | sum(attribute='count') %}
                    {% set converted = pipeline_data.get('Converted', {}).get('count', 0) %}
                    {{ (converted / total * 100) | round(1) if total > 0 else 0 }}%
                </div>
                <div class="stat-label">Conversion Rate</div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="dashboard-card">
            <div class="stat-card">
                <div class="stat-number text-warning" id="pipeline-value">
                    ${{ "{:,.0f}".format(pipeline_data.values() | sum(attribute='total_value')) }}
                </div>
                <div class="stat-label">Pipeline Value</div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="dashboard-card">
            <div class="stat-card">
                <div class="stat-number text-info" id="avg-deal-size">
                    {% set total_value = pipeline_data.values() | sum(attribute='total_value') %}
                    {% set total_leads = pipeline_data.values() | sum(attribute='count') %}
                    ${{ "{:,.0f}".format(total_value / total_leads) if total_leads > 0 else 0 }}
                </div>
                <div class="stat-label">Avg Deal Size</div>
            </div>
        </div>
    </div>
</div>

<!-- Pipeline Visualization -->
<div class="row">
    {% for status in statuses %}
    <div class="col-lg-2 col-md-4 col-sm-6 mb-4">
        <div class="pipeline-column" data-status="{{ status }}">
            <div class="pipeline-header pipeline-{{ status.lower() }}">
                <h6 class="mb-0">{{ status }}</h6>
                <div class="d-flex justify-content-between align-items-center mt-2">
                    <small id="{{ status.lower() }}-count">{{ pipeline_data.get(status, {}).get('count', 0) }}</small>
                    <small id="{{ status.lower() }}-value">${{ "{:,.0f}".format(pipeline_data.get(status, {}).get('total_value', 0)) }}</small>
                </div>
            </div>
            
            <div class="pipeline-leads" id="pipeline-{{ status.lower() }}">
                {% for lead in leads_by_status.get(status, []) %}
                <div class="lead-card" data-lead-id="{{ lead.id }}" draggable="true">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h6 class="mb-1">{{ lead.name }}</h6>
                        <div class="dropdown">
                            <button class="btn btn-sm btn-link" data-bs-toggle="dropdown">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" onclick="viewLead({{ lead.id }})">
                                    <i class="fas fa-eye me-2"></i>View Details
                                </a></li>
                                <li><a class="dropdown-item" href="#" onclick="editLead({{ lead.id }})">
                                    <i class="fas fa-edit me-2"></i>Edit
                                </a></li>
                                <li><a class="dropdown-item" href="#" onclick="scheduleMeeting({{ lead.id }})">
                                    <i class="fas fa-calendar me-2"></i>Schedule Meeting
                                </a></li>
                                {% if lead.status != 'Converted' %}
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item text-danger" href="#" onclick="deleteLead({{ lead.id }})">
                                    <i class="fas fa-trash me-2"></i>Delete
                                </a></li>
                                {% endif %}
                            </ul>
                        </div>
                    </div>
                    
                    <div class="small text-muted mb-2">
                        <i class="fas fa-phone me-1"></i>{{ lead.phone }}
                    </div>
                    
                    {% if lead.course_interest %}
                    <div class="small mb-2">
                        <span class="badge bg-info">{{ lead.course_interest.name }}</span>
                    </div>
                    {% endif %}
                    
                    {% if lead.quoted_amount and lead.quoted_amount > 0 %}
                    <div class="small text-success fw-bold mb-2">
                        <i class="fas fa-dollar-sign me-1"></i>${{ "{:,.0f}".format(lead.quoted_amount) }}
                    </div>
                    {% endif %}
                    
                    {% if lead.next_followup_date %}
                    <div class="small text-warning">
                        <i class="fas fa-clock me-1"></i>
                        Follow-up: {{ lead.next_followup_date.strftime('%b %d') }}
                    </div>
                    {% endif %}
                    
                    <div class="mt-2 pt-2 border-top">
                        <div class="d-flex gap-1">
                            <button class="btn btn-sm btn-outline-primary flex-fill" onclick="makeCall('{{ lead.phone }}')" title="Call">
                                <i class="fas fa-phone"></i>
                            </button>
                            {% if lead.whatsapp %}
                            <button class="btn btn-sm btn-outline-success flex-fill" onclick="openWhatsApp('{{ lead.whatsapp }}')" title="WhatsApp">
                                <i class="fab fa-whatsapp"></i>
                            </button>
                            {% endif %}
                            {% if lead.email %}
                            <button class="btn btn-sm btn-outline-info flex-fill" onclick="sendEmail('{{ lead.email }}')" title="Email">
                                <i class="fas fa-envelope"></i>
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
                
                {% if not leads_by_status.get(status, []) %}
                <div class="text-center text-muted py-4">
                    <i class="fas fa-inbox fa-2x mb-2"></i>
                    <p class="small mb-0">No leads in {{ status.lower() }} status</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Pipeline Analytics Chart -->
<div class="row mt-4">
    <div class="col-lg-8">
        <div class="chart-container">
            <canvas id="pipelineAnalyticsChart" height="300"></canvas>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="dashboard-card">
            <h5 class="mb-3">Pipeline Health</h5>
            
            <div class="mb-3">
                <div class="d-flex justify-content-between align-items-center mb-1">
                    <span class="small">Lead Generation</span>
                    <span class="small fw-bold text-success">Excellent</span>
                </div>
                <div class="progress-custom">
                    <div class="progress-bar-custom" style="width: 85%"></div>
                </div>
            </div>
            
            <div class="mb-3">
                <div class="d-flex justify-content-between align-items-center mb-1">
                    <span class="small">Qualification Rate</span>
                    <span class="small fw-bold text-warning">Good</span>
                </div>
                <div class="progress-custom">
                    <div class="progress-bar-custom" style="width: 70%"></div>
                </div>
            </div>
            
            <div class="mb-3">
                <div class="d-flex justify-content-between align-items-center mb-1">
                    <span class="small">Quote Conversion</span>
                    <span class="small fw-bold text-info">Average</span>
                </div>
                <div class="progress-custom">
                    <div class="progress-bar-custom" style="width: 60%"></div>
                </div>
            </div>
            
            <div class="mb-3">
                <div class="d-flex justify-content-between align-items-center mb-1">
                    <span class="small">Deal Velocity</span>
                    <span class="small fw-bold text-success">Fast</span>
                </div>
                <div class="progress-custom">
                    <div class="progress-bar-custom" style="width: 80%"></div>
                </div>
            </div>
            
            <hr>
            
            <div class="text-center">
                <h6 class="text-primary mb-1">Next Actions</h6>
                <p class="small text-muted mb-2">
                    {{ leads_by_status.get('New', []) | length }} new leads need first contact
                </p>
                <p class="small text-muted mb-2">
                    {{ leads_by_status.get('Contacted', []) | length }} leads awaiting follow-up
                </p>
                <p class="small text-muted">
                    {{ leads_by_status.get('Quoted', []) | length }} quotes pending decision
                </p>
            </div>
        </div>
    </div>
</div>

<!-- Quick Add Lead Modal Trigger -->
<div class="position-fixed bottom-0 end-0 p-4">
    <button class="btn btn-primary-custom rounded-circle" 
            style="width: 60px; height: 60px;" 
            data-bs-toggle="modal" 
            data-bs-target="#leadModal"
            title="Add New Lead">
        <i class="fas fa-plus fa-lg"></i>
    </button>
</div>

<!-- Lead Modal -->
{% include 'modals/lead_modal.html' %}
{% include 'modals/meeting_modal.html' %}
<!-- Lead Detail Modal -->
<div class="modal fade" id="leadDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Lead Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="leadDetailContent">
                <!-- Lead details will be loaded here -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/pipeline.js') }}"></script>
<script>
// Pipeline-specific JavaScript
document.addEventListener('DOMContentLoaded', function() {
    initializePipelineDragDrop();
    initializePipelineChart();
});

function initializePipelineChart() {
    const ctx = document.getElementById('pipelineAnalyticsChart');
    if (!ctx) return;

    const statuses = {{ statuses | tojsonfilter }};
    const counts = statuses.map(status => {{ pipeline_data | tojsonfilter }}[status]?.count || 0);
    const values = statuses.map(status => {{ pipeline_data | tojsonfilter }}[status]?.total_value || 0);

    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: statuses,
            datasets: [{
                label: 'Number of Leads',
                data: counts,
                backgroundColor: [
                    '#3498db', '#f39c12', '#e67e22', '#9b59b6', '#27ae60', '#e74c3c'
                ],
                borderRadius: 8,
                yAxisID: 'y'
            }, {
                label: 'Total Value ($)',
                data: values,
                type: 'line',
                borderColor: '#2c3e50',
                backgroundColor: 'rgba(44, 62, 80, 0.1)',
                borderWidth: 3,
                fill: false,
                tension: 0.4,
                yAxisID: 'y1'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Pipeline Analysis',
                    font: { size: 16, weight: 'bold' }
                },
                legend: {
                    position: 'top'
                }
            },
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Number of Leads'
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Value ($)'
                    },
                    ticks: {
                        callback: function(value) {
                            return '$' + value.toLocaleString();
                        }
                    },
                    grid: {
                        drawOnChartArea: false,
                    }
                }
            }
        }
    });
}

function viewLead(leadId) {
    // Load lead details in modal
    fetch(`/api/leads/${leadId}`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('leadDetailContent').innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Contact Information</h6>
                        <p><strong>Name:</strong> ${data.name}</p>
                        <p><strong>Phone:</strong> ${data.phone}</p>
                        <p><strong>Email:</strong> ${data.email || 'Not provided'}</p>
                        <p><strong>WhatsApp:</strong> ${data.whatsapp || 'Not provided'}</p>
                    </div>
                    <div class="col-md-6">
                        <h6>Lead Information</h6>
                        <p><strong>Status:</strong> <span class="status-badge status-${data.status.toLowerCase()}">${data.status}</span></p>
                        <p><strong>Source:</strong> ${data.lead_source || 'Unknown'}</p>
                        <p><strong>Course Interest:</strong> ${data.course_name || 'Not specified'}</p>
                        <p><strong>Quoted Amount:</strong> ${data.quoted_amount ? '$' + data.quoted_amount.toLocaleString() : 'Not quoted'}</p>
                    </div>
                </div>
                ${data.comments ? `<div class="mt-3"><h6>Comments</h6><p>${data.comments}</p></div>` : ''}
            `;
            new bootstrap.Modal(document.getElementById('leadDetailModal')).show();
        })
        .catch(error => {
            console.error('Error loading lead details:', error);
            showNotification('Error loading lead details', 'error');
        });
}

function editLead(leadId) {
    window.location.href = `/leads/${leadId}/edit`;
}

function scheduleMeeting(leadId) {
    // Open meeting modal with pre-selected lead
    const meetingModal = new bootstrap.Modal(document.getElementById('meetingModal'));
    const leadSelect = document.querySelector('#meetingModal select[name="lead_id"]');
    if (leadSelect) {
        leadSelect.value = leadId;
    }
    meetingModal.show();
}

function deleteLead(leadId) {
    if (confirm('Are you sure you want to delete this lead?')) {
        // Show loading
        showLoading();
        
        // Simulate delete
        setTimeout(() => {
            hideLoading();
            const leadCard = document.querySelector(`[data-lead-id="${leadId}"]`);
            if (leadCard) {
                leadCard.style.animation = 'fadeOut 0.3s ease-out';
                setTimeout(() => {
                    leadCard.remove();
                    updatePipelineStats();
                }, 300);
            }
            showNotification('Lead deleted successfully', 'success');
        }, 500);
    }
}

// Communication functions
function makeCall(phone) {
    if (confirm(`Call ${phone}?`)) {
        window.open(`tel:${phone}`);
    }
}

function openWhatsApp(phone) {
    const message = encodeURIComponent("Hi! I'm reaching out regarding your interest in our training courses.");
    window.open(`https://wa.me/${phone.replace(/\D/g, '')}?text=${message}`, '_blank');
}

function sendEmail(email) {
    const subject = encodeURIComponent("Training Course Inquiry Follow-up");
    const body = encodeURIComponent("Hi,\n\nThank you for your interest in our training courses. I'd like to discuss how we can help you achieve your learning goals.\n\nBest regards,\nTraining Center Team");
    window.open(`mailto:${email}?subject=${subject}&body=${body}`);
}

// Add fadeOut animation
const style = document.createElement('style');
style.textContent = `
    @keyframes fadeOut {
        from { opacity: 1; transform: scale(1); }
        to { opacity: 0; transform: scale(0.8); }
    }
`;
document.head.appendChild(style);
</script>
{% endblock %}
